var ID_PLANILHA = "1qJTkc17IQb8wOqezuABVIFgr7oPmodXu7OxHszsOdCA"; 

// ======================================================
// 1. L√ä OS DADOS DA PLANILHA (DO GET)
// ======================================================
function doGet(e) {
  var action = e.parameter ? e.parameter.action : "getConfig"; 
  var sheet = SpreadsheetApp.openById(ID_PLANILHA).getSheetByName("Config");
  
  if (action == "getConfig") {
    // Pega intervalo maior para garantir que H e I venham
    var data = sheet.getRange("A2:I2").getValues()[0];
    return ContentService.createTextOutput(JSON.stringify({
      tv: data[0], texto: data[2], temp: data[4], musica: data[5], botao: data[1], efeitos: "ON",
      // H2 √© o √≠ndice 7 (0=A, 1=B... 7=H)
      op1: data[7] || "Op√ß√£o 1", 
      op2: data[8] || "Op√ß√£o 2"
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  else if (action == "getEnquete") {
    // Pega H2, I2, J2, K2
    var range = sheet.getRange("H2:K2").getValues()[0];
    
    var nome1 = range[0] || "Op√ß√£o A"; // H2
    var nome2 = range[1] || "Op√ß√£o B"; // I2
    
    var v1 = parseInt(range[2]); if (isNaN(v1)) v1 = 0; // J2
    var v2 = parseInt(range[3]); if (isNaN(v2)) v2 = 0; // K2
    
    var total = v1 + v2;
    var p1 = 50, p2 = 50;
    
    if (total > 0) {
      p1 = Math.round((v1 / total) * 100);
      p2 = Math.round((v2 / total) * 100);
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      op1: nome1, op2: nome2, 
      votos1: v1, votos2: v2,
      porc1: p1, porc2: p2
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  else if (action == "getProgramacao") {
    return ContentService.createTextOutput(JSON.stringify([
      {id: "prog-06", hora: "06:00", titulo: "Manh√£ Top", descricao: "Energia total!"},
      {id: "prog-09", hora: "09:00", titulo: "Show da Manh√£", descricao: "M√∫sica e pr√™mios."},
      {id: "prog-12", hora: "12:00", titulo: "Top Hits", descricao: "As mais pedidas."},
      {id: "prog-17", hora: "17:00", titulo: "Tarde Top", descricao: "Sua melhor companhia."}
    ])).setMimeType(ContentService.MimeType.JSON);
  }
  return ContentService.createTextOutput("Action not found");
}

// ======================================================
// 2. GRAVA OS VOTOS (DO POST)
// ======================================================
function doPost(e) {
  var sheet = SpreadsheetApp.openById(ID_PLANILHA).getSheetByName("Config");
  // Trava para evitar conflito de votos simult√¢neos
  var lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    var data = JSON.parse(e.postData.contents);
    if (data.action == "votar_batalha") {
      var celula;
      // Voto 1 vai na J2, Voto 2 vai na K2
      if (data.voto == 1) celula = sheet.getRange("J2");
      else if (data.voto == 2) celula = sheet.getRange("K2");
      
      if (celula) {
        var valor = parseInt(celula.getValue());
        if (isNaN(valor)) valor = 0;
        celula.setValue(valor + 1);
      }
      return ContentService.createTextOutput("Voto OK");
    }
  } catch(err) {
  } finally {
    lock.releaseLock();
  }
  return ContentService.createTextOutput("OK");
}

// ======================================================
// 3. ROB√î DE ATUALIZA√á√ÉO (M√öSICA E OUVINTES)
// ======================================================
function atualizarSistemaAutomatico() {
  var ss = SpreadsheetApp.openById(ID_PLANILHA);
  var sheet = ss.getSheetByName("Config");
  if (!sheet) return;

  var musicaAtual = "";
  var ts = new Date().getTime(); 
  
  // TENTA LER VIA CODETABS (Mais forte contra bloqueio)
  try {
    var url = "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent("http://server27.srvsh.com.br:6674/currentsong?sid=1");
    var res = UrlFetchApp.fetch(url, {'muteHttpExceptions': true});
    if (res.getResponseCode() == 200) {
      var txt = res.getContentText().trim();
      if (txt.length > 2 && !txt.includes("HTML")) musicaAtual = txt;
    }
  } catch(e) {}

  // SE FALHAR, TENTA MANTER O √öLTIMO NOME V√ÅLIDO
  var ultimaSalva = sheet.getRange("F2").getValue().toString().trim();
  if (musicaAtual === "") {
     if (ultimaSalva !== "") musicaAtual = ultimaSalva;
     else musicaAtual = "R√°dio Top Itatiba";
  }

  if (musicaAtual !== ultimaSalva) {
    sheet.getRange("F2").setValue(musicaAtual);
    // Tenta capa
    try {
       var busca = "https://itunes.apple.com/search?term=" + encodeURIComponent(musicaAtual.replace(/-/g," ")) + "&media=music&limit=1";
       var json = JSON.parse(UrlFetchApp.fetch(busca).getContentText());
       if(json.results.length > 0) sheet.getRange("A2").setValue(json.results[0].artworkUrl100.replace("100x100bb","600x600bb"));
       else sheet.getRange("A2").setValue("https://radiotopitatiba.com.br/top1.jpg");
    } catch(e) { sheet.getRange("A2").setValue("https://radiotopitatiba.com.br/top1.jpg"); }
  }
  
  // Clima e Not√≠cias
  try {
    var clima = JSON.parse(UrlFetchApp.fetch("https://api.open-meteo.com/v1/forecast?latitude=-23.00&longitude=-46.84&current_weather=true").getContentText());
    var temp = Math.round(clima.current_weather.temperature);
    sheet.getRange("E2").setValue(temp);
    sheet.getRange("C2").setValue("‚òÄÔ∏è ITATIBA " + temp + "¬∞C .. üéµ NO AR: " + musicaAtual + " .. ‚ú® R√ÅDIO TOP!");
  } catch(e) {}
}
